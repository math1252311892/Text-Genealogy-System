<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        llm: '#7C3AED',
                        accent: '#4F46E5',
                        delete: '#EF4444',
                        insert: '#10B981',
                        replace: '#F59E0B'
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .toggle-checkbox:checked { right: 0; border-color: #7C3AED; }
            .toggle-checkbox:checked + .toggle-label { background-color: #7C3AED; }
            .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
            .collapsible-open .collapsible-content { max-height: 2000px; }
            .collapsible-icon { transition: transform 0.3s ease; }
            .collapsible-open .collapsible-icon { transform: rotate(180deg); }
            .diff-delete { @apply bg-red-100 text-red-800 line-through px-1 rounded; }
            .diff-insert { @apply bg-green-100 text-green-800 px-1 rounded; }
            .diff-replace-old { @apply bg-amber-100 text-amber-800 line-through px-1 rounded mr-1; }
            .diff-replace-new { @apply bg-amber-100 text-amber-800 px-1 rounded ml-1; }
            .modal-backdrop { @apply fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300; }
            .modal-backdrop.active { @apply opacity-100 pointer-events-auto; }
            .modal-content { @apply bg-white rounded-xl shadow-xl max-w-3xl w-full max-h-[80vh] transform transition-all duration-300 scale-95 opacity-0; }
            .modal-backdrop.active .modal-content { @apply scale-100 opacity-100; }
        }
    </style>
    
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
        .prose br { margin-bottom: 0.5rem; display: block; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-pattern {
            background-color: #f8fafc;
            background-image: 
                radial-gradient(rgba(37, 99, 235, 0.05) 1px, transparent 1px),
                radial-gradient(rgba(124, 58, 237, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
        }
        .editor-box {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }
        .editor-box:focus-within {
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        /* æœ¬åœ°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ ·å¼ */
        .local-editor-toolbar {
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 12px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            background-color: #f9fafb;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .local-editor-button {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            border: 1px solid transparent;
            background: none;
            cursor: pointer;
            color: #4b5563;
            transition: all 0.15s ease;
        }
        .local-editor-button:hover {
            background-color: #eff6ff;
            color: #2563eb;
            border-color: #dbeafe;
        }
        .local-editor-button.active {
            background-color: #dbeafe;
            color: #2563eb;
            border-color: #bfdbfe;
        }
        .local-editor-separator {
            width: 1px;
            background-color: #e2e8f0;
            margin: 0 4px;
        }
        .local-editor-content {
            min-height: 250px;
            padding: 16px;
            outline: none;
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
            background-color: white;
        }
        .local-editor-content p {
            margin: 0 0 1em 0;
        }
        .local-editor-content p:last-child {
            margin-bottom: 0;
        }
        /* æ£€éªŒæ¨¡å¼å¼€å…³æ ·å¼ */
        .verify-mode-toggle {
            display: flex;
            align-items: center;
            margin-left: 8px;
            padding: 0 8px;
            height: 32px;
            font-size: 13px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 18px;
            margin: 0 6px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 18px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #7C3AED;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }
        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown-container {
            position: relative;
            width: 100%;
        }
        .dropdown-header {
            background-gradient-to-r from-blue-50 to-indigo-50;
            border: 1px solid #dbeafe;
            border-radius: 0.75rem;
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .dropdown-open .dropdown-content {
            max-height: 200px;
            padding: 0.5rem 0;
        }
        .dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }
        .dropdown-item:hover {
            background-color: #f1f5f9;
        }
        .dropdown-item input {
            margin-right: 0.5rem;
        }
        /* é€‰æ‹©æç¤ºæ ·å¼ */
        .selection-info {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            padding-left: 4px;
        }
        /* å¼•ç”¨ä¿¡æ¯æ ·å¼ */
        .reference-metadata {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            padding-left: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
    </style>
</head>
<body class="bg-pattern font-sans text-gray-800 min-h-screen">
    <!-- å¼•ç”¨åŸæ–‡æ¨¡æ€æ¡† -->
    <div id="reference-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-accent">å¼•ç”¨åŸæ–‡</h3>
                <button id="close-reference-modal" class="text-gray-500 hover:text-gray-700">Ã—</button>
            </div>
            <div id="reference-modal-content" class="p-5 overflow-y-auto max-h-[calc(80vh-120px)]"></div>
            <div class="p-4 border-t border-gray-200 flex justify-end">
                <button id="close-reference-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm transition-colors">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ä¸­é—´ç»“æœæ¨¡æ€æ¡† -->
    <div id="entries-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-accent">ä¸­é—´ç»“æœ</h3>
                <button id="close-entries-modal" class="text-gray-500 hover:text-gray-700">Ã—</button>
            </div>
            
            <div id="entries-subnav" class="sticky top-0 bg-white border-b border-gray-200 shadow-sm">
                <div class="container mx-auto px-4">
                    <div class="flex flex-wrap items-center gap-2 py-3 overflow-x-auto hide-scrollbar">
                        <button data-entries-page="generation-info" class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-primary hover:bg-gray-50 transition-colors">
                            å¢å¼ºææ–™ç”Ÿæˆ
                        </button>
                        <button data-entries-page="search-entries" class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-primary hover:bg-gray-50 transition-colors">
                            ç›¸å…³è¯æ¡
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="entries-modal-content" class="p-5 overflow-y-auto max-h-[calc(80vh-160px)]">
                <div id="entries-content">
                    <div id="generation-info-page" class="hidden"></div>
                    <div id="search-entries-page" class="hidden"></div>
                    <div id="entries-default-content" class="text-center py-16">
                        <div class="w-20 h-20 mx-auto bg-gray-100 rounded-xl flex items-center justify-center mb-6">
                            <span class="text-gray-300 text-4xl">â‰¡</span>
                        </div>
                        <p class="text-gray-500">è¯·ä»ä¸Šæ–¹é€‰æ‹©è¦æŸ¥çœ‹çš„å¤„ç†æ­¥éª¤</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 flex justify-end">
                <button id="close-entries-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm transition-colors">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- é¡µé¢å®¹å™¨ -->
    <div>
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-llm flex items-center justify-center shadow-md">
                        <i class="fa fa-book text-white text-xl"></i>
                    </div>
                    <h1 class="text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-llm">æ–‡å®</h1>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒº - ä¸¤åˆ—å¸ƒå±€ -->
        <main class="container mx-auto px-4 py-8">
            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- å·¦ä¾§åˆ—ï¼šè¾“å…¥ + æŒ‰é’® -->
                <div class="flex flex-col space-y-6">
                    <!-- è¾“å…¥åŒºåŸŸï¼ˆæœ¬åœ°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼‰ -->
                    <div class="bg-white rounded-2xl shadow-md p-5 card-hover">
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ ¡éªŒæ–‡æœ¬ç¼–è¾‘å™¨</label>
                            <div class="text-xs text-gray-500 mb-2">å¯ä½¿ç”¨é¼ æ ‡é€‰æ‹©éƒ¨åˆ†æ–‡æœ¬è¿›è¡Œæ ¡éªŒï¼Œæœªé€‰æ‹©æ—¶å°†æ ¡éªŒå…¨éƒ¨æ–‡æœ¬</div>
                        </div>
                        <div class="editor-box">
                            <!-- ç¼–è¾‘å™¨å·¥å…·æ  -->
                            <div class="local-editor-toolbar">
                                <button class="local-editor-button" data-command="formatBlock" data-value="<h1>" title="æ ‡é¢˜1">
                                    <b>H1</b>
                                </button>
                                <button class="local-editor-button" data-command="formatBlock" data-value="<h2>" title="æ ‡é¢˜2">
                                    <b>H2</b>
                                </button>
                                <button class="local-editor-button" data-command="formatBlock" data-value="<p>" title="æ®µè½">
                                    <b>Â¶</b>
                                </button>
                                <div class="local-editor-separator"></div>
                                <button class="local-editor-button" data-command="bold" title="åŠ ç²—">
                                    <b>B</b>
                                </button>
                                <button class="local-editor-button" data-command="italic" title="æ–œä½“">
                                    <i>I</i>
                                </button>
                                <button class="local-editor-button" data-command="underline" title="ä¸‹åˆ’çº¿">
                                    <u>U</u>
                                </button>
                                <div class="local-editor-separator"></div>
                                <button class="local-editor-button" data-command="insertUnorderedList" title="æ— åºåˆ—è¡¨">
                                    <i class="fa fa-list-ul"></i>
                                </button>
                                <button class="local-editor-button" data-command="insertOrderedList" title="æœ‰åºåˆ—è¡¨">
                                    <i class="fa fa-list-ol"></i>
                                </button>
                                <div class="local-editor-separator"></div>
                                <button class="local-editor-button" data-command="justifyLeft" title="å·¦å¯¹é½">
                                    <i class="fa fa-align-left"></i>
                                </button>
                                <button class="local-editor-button" data-command="justifyCenter" title="å±…ä¸­å¯¹é½">
                                    <i class="fa fa-align-center"></i>
                                </button>
                                <button class="local-editor-button" data-command="justifyRight" title="å³å¯¹é½">
                                    <i class="fa fa-align-right"></i>
                                </button>
                                <div class="local-editor-separator"></div>
                                <button class="local-editor-button" data-command="undo" title="æ’¤é”€">
                                    <i class="fa fa-undo"></i>
                                </button>
                                <button class="local-editor-button" data-command="redo" title="é‡åš">
                                    <i class="fa fa-repeat"></i>
                                </button>
                            </div>
                            <!-- ç¼–è¾‘å™¨å†…å®¹åŒº -->
                            <div id="local-rich-text-editor" class="local-editor-content" contenteditable="true">
                                <p>è¯·è¾“å…¥æ‚¨æƒ³è¦æ ¡éªŒçš„æ–‡æœ¬...</p>
                            </div>
                            <!-- é€‰æ‹©ä¿¡æ¯æç¤º -->
                            <div id="selection-info" class="selection-info hidden">å·²é€‰æ‹© <span id="selection-length">0</span> ä¸ªå­—ç¬¦</div>
                        </div>
                    </div>
                    
                    <!-- æ–°å¢é—®ç­”è¾“å…¥æ¡† -->
                    <div class="bg-white rounded-2xl shadow-md p-5 card-hover">
                        <div class="mb-3">
                            <label for="question-input" class="block text-sm font-medium text-gray-700 mb-1">é—®ç­”è¾“å…¥æ¡†</label>
                            <div class="text-xs text-gray-500 mb-2">åœ¨é—®ç­”æ¨¡å¼ä¸‹ï¼Œå°†ä½¿ç”¨æ­¤æ–‡æœ¬è¿›è¡Œæ£€ç´¢</div>
                        </div>
                        <textarea 
                            id="question-input" 
                            class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm min-h-[100px]"
                            placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                        ></textarea>
                    </div>
                    
                    <!-- æ£€ç´¢æŒ‰é’® -->
                    <div class="flex">
                        <button id="search-button" class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-md w-full" disabled>
                            <i class="fa fa-search mr-2"></i>å¼€å§‹æ£€ç´¢
                        </button>
                    </div>
                </div>
                
                <!-- å³ä¾§åˆ—ï¼šç»“æœåŒºåŸŸ + åŠŸèƒ½é€‰æ‹© -->
                <div class="flex flex-col space-y-6">
                    <!-- ç»“æœåŒºåŸŸ -->
                    <div class="bg-white rounded-2xl shadow-md p-5 h-full card-hover">
                        <!-- åˆå§‹çŠ¶æ€ -->
                        <div id="search-initial-state" class="text-center py-16">
                            <div class="w-20 h-20 mx-auto bg-gray-100 rounded-xl flex items-center justify-center mb-6">
                                <span class="text-gray-300 text-4xl">ğŸ”</span>
                            </div>
                            <p class="text-gray-500">è¯·åœ¨å·¦ä¾§è¾“å…¥å†…å®¹å¹¶ç‚¹å‡»"å¼€å§‹æ£€ç´¢"</p>
                        </div>
                        
                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div id="search-loading-indicator" class="hidden text-center py-16">
                            <div class="inline-block animate-spin rounded-full h-14 w-14 border-t-2 border-b-2 border-primary mb-6"></div>
                            <p class="text-gray-600">æ­£åœ¨æ£€ç´¢ç›¸å…³ææ–™ï¼Œè¯·ç¨å€™...</p>
                        </div>

                        <!-- ç»“æœåŒºåŸŸ -->
                        <div id="search-results-container" class="hidden">
                            <div class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b border-gray-100">
                                <h3 class="text-xl font-semibold text-accent">ç»“æœ</h3>
                                <div class="text-sm text-gray-500 mt-2 sm:mt-0">
                                    <span id="search-result-stats">æ‰¾åˆ° 0 æ¡ç»“æœ</span>
                                    <span id="search-processing-time" class="ml-4"></span>
                                </div>
                            </div>
                            
                            <!-- æ— ç»“æœçŠ¶æ€ -->
                            <div id="search-no-results" class="hidden text-center py-16">
                                <div class="w-20 h-20 mx-auto bg-gray-100 rounded-xl flex items-center justify-center mb-6">
                                    <span class="text-gray-300 text-4xl">âœ–</span>
                                </div>
                                <p class="text-gray-500">æœªæ‰¾åˆ°ç›¸å…³ææ–™</p>
                                <button id="search-try-again-button" class="mt-4 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                                    å°è¯•å¤§æ¨¡å‹å¢å¼ºæ£€ç´¢
                                </button>
                            </div>
                            
                            <!-- å·®å¼‚å¯è§†åŒ– -->
                            <div id="diff-visualization-container" class="hidden space-y-6">
                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                                    <h4 class="text-lg font-medium text-gray-800 mb-4">æ–‡æœ¬ä¿®æ­£</h4>
                                    <div id="diff-merged-view" class="py-3 px-2 bg-white rounded-lg min-h-[60px] text-base leading-relaxed"></div>
                                </div>
                                <!-- å¼•ç”¨åŸæ–‡é“¾æ¥æ”¾åœ¨æ¡†å¤–ä¸‹æ–¹ï¼Œå³å¯¹é½ -->
                                <div id="diff-reference-link-container" class="flex justify-end mt-1 mb-2">
                                    <button onclick="window.showReferenceModal()" class="text-primary hover:text-primary/80 text-sm font-medium flex items-center transition-colors">
                                        <i class="fa fa-link mr-1"></i>å¼•ç”¨åŸæ–‡
                                    </button>
                                </div>
                                
                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                                    <h4 class="text-lg font-medium text-gray-800 mb-4">ä¿®æ­£è¯´æ˜</h4>
                                    <div id="diff-explanations" class="space-y-3 pl-2"></div>
                                </div>
                                <!-- ä¸­é—´ç»“æœé“¾æ¥æ”¾åœ¨æ¡†å¤–ä¸‹æ–¹ï¼Œå³å¯¹é½ -->
                                <div id="show-entries-link" class="flex justify-end mt-1 mb-2 hidden">
                                    <button class="text-primary hover:text-primary/80 text-sm font-medium flex items-center transition-colors">
                                        <i class="fa fa-list mr-1"></i>æŸ¥çœ‹ä¸­é—´ç»“æœ
                                    </button>
                                </div>
                            </div>
                            
                            <!-- å¤„ç†ç»“æœ -->
                            <div id="search-processed-content-container" class="space-y-6 max-h-[calc(100vh-220px)] overflow-y-auto">
                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                                    <h4 class="text-lg font-medium text-gray-800 mb-4">å›ç­”ç»“æœ</h4>
                                    <div id="processed-content"></div>
                                </div>
                                <!-- å¼•ç”¨åŸæ–‡é“¾æ¥æ”¾åœ¨æ¡†å¤–ä¸‹æ–¹ï¼Œå³å¯¹é½ -->
                                <div id="processed-reference-link-container" class="flex justify-end mt-1 mb-2">
                                    <button onclick="window.showReferenceModal()" class="text-primary hover:text-primary/80 text-sm font-medium flex items-center transition-colors">
                                        <i class="fa fa-link mr-1"></i>å¼•ç”¨åŸæ–‡
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- é”™è¯¯ä¿¡æ¯ -->
                        <div id="search-error-message" class="hidden py-16">
                            <div class="flex items-start">
                                <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center mr-4 mt-1">
                                    <span class="text-red-500 text-xl">!</span>
                                </div>
                                <div>
                                    <h3 class="font-medium text-red-800 text-lg">æ£€ç´¢å¤±è´¥</h3>
                                    <div class="mt-2 text-sm text-red-700" id="search-error-details"></div>
                                    <button id="search-retry-button" class="mt-4 bg-red-50 hover:bg-red-100 text-red-700 px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                                        é‡è¯•
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŠŸèƒ½é€‰æ‹©åŒºåŸŸï¼ˆç§»è‡³ç»“æœä¸‹æ–¹ï¼‰ -->
                    <div class="bg-white rounded-2xl shadow-md p-5 card-hover">
                        <div class="flex flex-wrap gap-4">
                            <!-- æ£€ç´¢ç±»å‹ - ä¸‹æ‹‰å¼å±•å¼€ -->
                            <div class="flex-1 min-w-[200px]">
                                <div class="dropdown-container" id="knowledge-source-dropdown">
                                    <div class="dropdown-header">
                                        <div id="selected-knowledge-source">çŸ¥è¯†æº: é‡è¦è®²è¯</div>
                                        <span class="text-xs text-gray-500 collapsible-icon">â–¼</span>
                                    </div>
                                    <div class="dropdown-content">
                                        <div class="dropdown-item">
                                            <input type="radio" id="search-type-speech" name="search-type" value="speech" class="w-4 h-4 text-primary focus:ring-primary border-gray-300" checked>
                                            <label for="search-type-speech" class="ml-2 text-sm text-gray-700">é‡è¦è®²è¯</label>
                                        </div>
                                        <div class="dropdown-item">
                                            <input type="radio" id="search-type-encyclopedia" name="search-type" value="encyclopedia" class="w-4 h-4 text-accent focus:ring-accent border-gray-300">
                                            <label for="search-type-encyclopedia" class="ml-2 text-sm text-gray-700">çŸ¥è¯†ç™¾ç§‘</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å¤§æ¨¡å‹å¢å¼º -->
                            <div class="flex-1 min-w-[200px]">
                                <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-3 rounded-xl border border-purple-100 h-full">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-800">å¤§æ¨¡å‹å¢å¼ºæ£€ç´¢</label>
                                        </div>
                                        <div class="relative inline-block w-12 h-6">
                                            <input type="checkbox" id="search-use-llm-enhancement" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all checked:right-0 checked:border-llm" checked>
                                            <label for="search-use-llm-enhancement" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ¸…é™¤å†…å®¹æŒ‰é’® -->
                            <div class="flex items-center min-w-[120px]">
                                <button id="search-clear-button" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    æ¸…é™¤å†…å®¹
                                </button>
                            </div>
                        </div>
                        
                        <!-- æ¨¡å¼åˆ‡æ¢ -->
                        <div class="mt-4">
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100 p-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-800">æ¨¡å¼é€‰æ‹©</label>
                                        <div class="text-xs text-gray-500 mt-1">æ ¡éªŒæ¨¡å¼ï¼šä½¿ç”¨ç¼–è¾‘å™¨æ–‡æœ¬ | é—®ç­”æ¨¡å¼ï¼šä½¿ç”¨é—®ç­”æ¡†æ–‡æœ¬</div>
                                    </div>
                                    <div class="verify-mode-toggle">
                                        é—®ç­”æ¨¡å¼
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="search-verify-mode" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        æ ¡éªŒæ¨¡å¼
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- é¡µè„š -->
        <footer class="bg-gray-800 text-white/80 py-6 mt-8">
            <div class="container mx-auto px-4 text-center">
                <p class="text-sm">æ–‡å® Â© åŒ—äº¬å¤§å­¦ç‹é€‰è®¡ç®—æœºç ”ç©¶æ‰€2025</p>
            </div>
        </footer>
    </div>

    <script>
        let searchResultsData = null;
        let currentSearchType = 'speech';
        let richTextEditor = null; // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®ä¾‹
        const apiUrls = {
            speech: 'http://222.29.51.246:8085/search_references',
            encyclopedia: 'http://222.29.51.246:8081/search_references'
        };
        
        // DOMå…ƒç´ å¼•ç”¨
        const elements = {
            // æ¨¡æ€æ¡†ç›¸å…³
            referenceModal: document.getElementById('reference-modal'),
            referenceModalContent: document.getElementById('reference-modal-content'),
            closeReferenceModal: document.getElementById('close-reference-modal'),
            closeReferenceBtn: document.getElementById('close-reference-btn'),
            entriesModal: document.getElementById('entries-modal'),
            closeEntriesModal: document.getElementById('close-entries-modal'),
            closeEntriesBtn: document.getElementById('close-entries-btn'),
            showEntriesLink: document.getElementById('show-entries-link'),
            
            // ç»“æœå±•ç¤ºç›¸å…³
            diffVisualizationContainer: document.getElementById('diff-visualization-container'),
            diffMergedView: document.getElementById('diff-merged-view'),
            diffExplanations: document.getElementById('diff-explanations'),
            processedContentContainer: document.getElementById('search-processed-content-container'),
            diffReferenceLinkContainer: document.getElementById('diff-reference-link-container'),
            processedReferenceLinkContainer: document.getElementById('processed-reference-link-container'),
            
            // æœç´¢ç›¸å…³
            searchButton: document.getElementById('search-button'),
            clearButton: document.getElementById('search-clear-button'),
            tryAgainButton: document.getElementById('search-try-again-button'),
            retryButton: document.getElementById('search-retry-button'),
            useLlmEnhancement: document.getElementById('search-use-llm-enhancement'),
            verifyModeCheckbox: document.getElementById('search-verify-mode'),
            initialState: document.getElementById('search-initial-state'),
            loadingIndicator: document.getElementById('search-loading-indicator'),
            resultsContainer: document.getElementById('search-results-container'),
            processedContent: document.getElementById('processed-content'),
            noResults: document.getElementById('search-no-results'),
            resultStats: document.getElementById('search-result-stats'),
            processingTime: document.getElementById('search-processing-time'),
            errorMessage: document.getElementById('search-error-message'),
            errorDetails: document.getElementById('search-error-details'),
            
            // ä¸­é—´ç»“æœ
            entriesSubnavBtns: document.querySelectorAll('[data-entries-page]'),
            entriesSubpages: document.querySelectorAll('[id$="-page"]'),
            entriesDefaultContent: document.getElementById('entries-default-content'),
            
            // æœ¬åœ°ç¼–è¾‘å™¨å’Œé—®ç­”æ¡†
            editorElement: document.getElementById('local-rich-text-editor'),
            questionInput: document.getElementById('question-input'),
            editorButtons: document.querySelectorAll('.local-editor-button'),
            selectionInfo: document.getElementById('selection-info'),
            selectionLength: document.getElementById('selection-length'),
            
            // çŸ¥è¯†æºä¸‹æ‹‰èœå•
            knowledgeSourceDropdown: document.getElementById('knowledge-source-dropdown'),
            selectedKnowledgeSource: document.getElementById('selected-knowledge-source'),
            searchTypeRadios: document.querySelectorAll('input[name="search-type"]')
        };

        // è·å–ç¼–è¾‘å™¨ä¸­é€‰ä¸­çš„æ–‡æœ¬
        function getSelectedText() {
            if (window.getSelection) {
                return window.getSelection().toString();
            } else if (document.selection && document.selection.type !== "Control") {
                return document.selection.createRange().text;
            }
            return '';
        }

        // æ›´æ–°é€‰æ‹©ä¿¡æ¯æ˜¾ç¤º
        function updateSelectionInfo() {
            const selectedText = getSelectedText();
            const verifyMode = elements.verifyModeCheckbox.checked;
            
            if (verifyMode && selectedText) {
                elements.selectionLength.textContent = selectedText.length;
                elements.selectionInfo.classList.remove('hidden');
            } else {
                elements.selectionInfo.classList.add('hidden');
            }
            
            checkInputContent();
        }

        // åˆå§‹åŒ–æœ¬åœ°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        function initLocalRichTextEditor() {
            // å­˜å‚¨ç¼–è¾‘å™¨å…ƒç´ å¼•ç”¨
            richTextEditor = elements.editorElement;
            
            // ç»‘å®šå·¥å…·æ æŒ‰é’®äº‹ä»¶
            elements.editorButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const command = this.getAttribute('data-command');
                    const value = this.getAttribute('data-value') || null;
                    
                    // æ‰§è¡Œæ–‡æ¡£å‘½ä»¤
                    document.execCommand(command, false, value);
                    
                    // èšç„¦åˆ°ç¼–è¾‘å™¨
                    richTextEditor.focus();
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateEditorButtonStates();
                });
            });
            
            // ç›‘å¬ç¼–è¾‘å™¨å†…å®¹å˜åŒ–å’Œé€‰æ‹©å˜åŒ–
            richTextEditor.addEventListener('input', checkInputContent);
            richTextEditor.addEventListener('mouseup', updateSelectionInfo);
            richTextEditor.addEventListener('keyup', function() {
                updateEditorButtonStates();
                updateSelectionInfo();
            });
            richTextEditor.addEventListener('mouseup', updateEditorButtonStates);
            
            // åˆå§‹åŒ–ç‚¹å‡»ç¼–è¾‘å™¨æ—¶æ¸…ç©ºé»˜è®¤æ–‡æœ¬
            richTextEditor.addEventListener('click', function() {
                const defaultText = 'è¯·è¾“å…¥æ‚¨æƒ³è¦æ ¡éªŒçš„æ–‡æœ¬...';
                if (this.innerText.trim() === defaultText) {
                    this.innerHTML = '';
                }
            });
            
            // åˆå§‹åŒ–é—®ç­”æ¡†
            elements.questionInput.addEventListener('input', checkInputContent);
            
            // æ¨¡å¼åˆ‡æ¢æ—¶æ›´æ–°é€‰æ‹©ä¿¡æ¯
            elements.verifyModeCheckbox.addEventListener('change', updateSelectionInfo);
            
            // åˆå§‹åŒ–æ£€æŸ¥
            checkInputContent();
            updateEditorButtonStates();
        }
        
        // æ›´æ–°ç¼–è¾‘å™¨æŒ‰é’®çŠ¶æ€ï¼ˆåæ˜ å½“å‰é€‰ä¸­å†…å®¹çš„æ ¼å¼ï¼‰
        function updateEditorButtonStates() {
            elements.editorButtons.forEach(button => {
                const command = button.getAttribute('data-command');
                
                // æ£€æŸ¥å‘½ä»¤çŠ¶æ€
                if (['bold', 'italic', 'underline', 'insertUnorderedList', 'insertOrderedList', 'justifyLeft', 'justifyCenter', 'justifyRight'].includes(command)) {
                    if (document.queryCommandState(command)) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                }
            });
        }
        
        // æ£€æŸ¥è¾“å…¥å†…å®¹çŠ¶æ€
        function checkInputContent() {
            if (!richTextEditor) return;
            
            const verifyMode = elements.verifyModeCheckbox.checked;
            const editorDefaultText = 'è¯·è¾“å…¥æ‚¨æƒ³è¦æ ¡éªŒçš„æ–‡æœ¬...';
            const questionDefaultText = 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...';
            
            // ç¼–è¾‘å™¨å†…å®¹æ£€æŸ¥
            const editorHasContent = richTextEditor.innerText.trim() !== '' && richTextEditor.innerText.trim() !== editorDefaultText;
            // é€‰ä¸­å†…å®¹æ£€æŸ¥
            const hasSelectedText = getSelectedText().length > 0;
            // é—®ç­”æ¡†å†…å®¹æ£€æŸ¥
            const questionHasContent = elements.questionInput.value.trim() !== '' && elements.questionInput.value.trim() !== questionDefaultText;
            
            // æ ¹æ®å½“å‰æ¨¡å¼åˆ¤æ–­æ˜¯å¦æœ‰æœ‰æ•ˆå†…å®¹
            const hasValidContent = verifyMode 
                ? (editorHasContent && (!hasSelectedText || getSelectedText().length > 0)) 
                : questionHasContent;
            
            elements.searchButton.disabled = !hasValidContent;
            elements.clearButton.disabled = !(editorHasContent || questionHasContent);
        }
        
        // æ¸…é™¤è¾“å…¥å†…å®¹
        function clearInputContent() {
            if (richTextEditor) {
                richTextEditor.innerHTML = '<p>è¯·è¾“å…¥æ‚¨æƒ³è¦æ ¡éªŒçš„æ–‡æœ¬...</p>';
            }
            elements.questionInput.value = '';
            
            // æ¸…é™¤é€‰æ‹©
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            } else if (document.selection) {
                document.selection.empty();
            }
            
            checkInputContent();
            updateEditorButtonStates();
            updateSelectionInfo();
        }
        
        // è·å–å½“å‰æ¨¡å¼ä¸‹çš„æ–‡æœ¬å†…å®¹
        function getCurrentModeTextContent() {
            const verifyMode = elements.verifyModeCheckbox.checked;
            
            if (verifyMode) {
                // æ ¡éªŒæ¨¡å¼ - ä¼˜å…ˆä½¿ç”¨é€‰ä¸­çš„æ–‡æœ¬ï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨å…¨éƒ¨æ–‡æœ¬
                const selectedText = getSelectedText().trim();
                if (selectedText) {
                    return selectedText;
                }
                
                // æ²¡æœ‰é€‰ä¸­å†…å®¹åˆ™ä½¿ç”¨å…¨éƒ¨æ–‡æœ¬
                if (!richTextEditor) return '';
                const defaultText = 'è¯·è¾“å…¥æ‚¨æƒ³è¦æ ¡éªŒçš„æ–‡æœ¬...';
                const text = richTextEditor.innerText.trim();
                return text === defaultText ? '' : text;
            } else {
                // é—®ç­”æ¨¡å¼ - ä½¿ç”¨é—®ç­”æ¡†å†…å®¹
                const defaultText = 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...';
                const text = elements.questionInput.value.trim();
                return text === defaultText ? '' : text;
            }
        }
        
        // åˆå§‹åŒ–å¯æŠ˜å åŒºåŸŸ
        function initCollapsibleSections() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.parentElement.classList.toggle('collapsible-open');
                });
            });
            // é»˜è®¤å±•å¼€ç¬¬ä¸€ä¸ªå¯æŠ˜å åŒºåŸŸ
            document.querySelector('.collapsible-header')?.click();
        }
        
        // åˆå§‹åŒ–çŸ¥è¯†æºä¸‹æ‹‰èœå•
        function initKnowledgeSourceDropdown() {
            const dropdown = elements.knowledgeSourceDropdown;
            const header = dropdown.querySelector('.dropdown-header');
            const content = dropdown.querySelector('.dropdown-content');
            const radioButtons = dropdown.querySelectorAll('input[name="search-type"]');
            const selectedText = elements.selectedKnowledgeSource;
            
            // ç‚¹å‡»ä¸‹æ‹‰å¤´éƒ¨åˆ‡æ¢å±•å¼€/æ”¶èµ·çŠ¶æ€
            header.addEventListener('click', () => {
                dropdown.classList.toggle('dropdown-open');
            });
            
            // ç‚¹å‡»ä¸‹æ‹‰é¡¹é€‰æ‹©çŸ¥è¯†æº
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                    const label = this.nextElementSibling.textContent;
                    selectedText.textContent = `çŸ¥è¯†æº: ${label}`;
                    
                    // æ”¶èµ·ä¸‹æ‹‰èœå•
                    dropdown.classList.remove('dropdown-open');
                });
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ”¶èµ·ä¸‹æ‹‰èœå•
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('dropdown-open');
                }
            });
        }
        
        // åˆå§‹åŒ–æ¨¡æ€æ¡†
        function initModals() {
            const hideReferenceModal = () => {
                elements.referenceModal.classList.remove('active');
                document.body.classList.remove('overflow-hidden');
            };
            
            const showReferenceModal = () => {
                elements.referenceModal.classList.add('active');
                document.body.classList.add('overflow-hidden');
            };
            
            const hideEntriesModal = () => {
                elements.entriesModal.classList.remove('active');
                document.body.classList.remove('overflow-hidden');
            };
            
            const showEntriesModal = () => {
                if (searchResultsData) {
                    elements.entriesModal.classList.add('active');
                    document.body.classList.add('overflow-hidden');
                    displayIntermediateResults(searchResultsData);
                    // æ¿€æ´»ç¬¬ä¸€ä¸ªå¯ç”¨æ ‡ç­¾
                    const firstValidBtn = Array.from(elements.entriesSubnavBtns).find(
                        btn => !btn.classList.contains('opacity-50', 'pointer-events-none')
                    );
                    firstValidBtn?.click();
                }
            };
            
            // ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
            elements.closeReferenceModal.addEventListener('click', hideReferenceModal);
            elements.closeReferenceBtn.addEventListener('click', hideReferenceModal);
            elements.closeEntriesModal.addEventListener('click', hideEntriesModal);
            elements.closeEntriesBtn.addEventListener('click', hideEntriesModal);
            elements.referenceModal.addEventListener('click', e => e.target === elements.referenceModal && hideReferenceModal());
            elements.entriesModal.addEventListener('click', e => e.target === elements.entriesModal && hideEntriesModal());
            elements.showEntriesLink.addEventListener('click', showEntriesModal);
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    if (elements.referenceModal.classList.contains('active')) hideReferenceModal();
                    if (elements.entriesModal.classList.contains('active')) hideEntriesModal();
                }
            });
            
            window.showReferenceModal = showReferenceModal;
        }
        
        // åˆ‡æ¢ä¸­é—´ç»“æœæ ‡ç­¾é¡µ
        function initEntriesSubnav() {
            elements.entriesSubnavBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const pageId = btn.getAttribute('data-entries-page');
                    // éšè—æ‰€æœ‰é¡µé¢
                    elements.entriesSubpages.forEach(page => page.classList.add('hidden'));
                    elements.entriesDefaultContent.classList.add('hidden');
                    
                    // é‡ç½®æŒ‰é’®æ ·å¼
                    elements.entriesSubnavBtns.forEach(b => {
                        b.classList.remove('bg-primary', 'text-white', 'shadow-md');
                        b.classList.add('bg-white', 'text-primary', 'hover:bg-gray-50');
                    });
                    
                    // æ˜¾ç¤ºç›®æ ‡é¡µé¢
                    const targetPage = document.getElementById(`${pageId}-page`);
                    if (targetPage) {
                        targetPage.classList.remove('hidden');
                        btn.classList.remove('bg-white', 'text-primary', 'hover:bg-gray-50');
                        btn.classList.add('bg-primary', 'text-white', 'shadow-md');
                    } else {
                        elements.entriesDefaultContent.classList.remove('hidden');
                    }
                });
            });
        }
        
        // æ–‡æœ¬å·®å¼‚è®¡ç®—
        function getEditOperations(s, t) {
            const m = s.length, n = t.length;
            const d = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
            
            for (let i = 0; i <= m; i++) d[i][0] = i;
            for (let j = 0; j <= n; j++) d[0][j] = j;
            
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    const cost = s[i - 1] === t[j - 1] ? 0 : 1;
                    d[i][j] = Math.min(
                        d[i - 1][j] + 1,
                        d[i][j - 1] + 1,
                        d[i - 1][j - 1] + cost
                    );
                }
            }
            
            const operations = [];
            let i = m, j = n;
            
            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && s[i - 1] === t[j - 1]) {
                    operations.unshift({ type: 'match', char: s[i - 1] });
                    i--; j--;
                } else {
                    const current = d[i][j];
                    if (i > 0 && d[i - 1][j] + 1 === current) {
                        operations.unshift({ type: 'delete', char: s[i - 1] });
                        i--;
                    } else if (j > 0 && d[i][j - 1] + 1 === current) {
                        operations.unshift({ type: 'insert', char: t[j - 1] });
                        j--;
                    } else {
                        operations.unshift({ type: 'replace', oldChar: s[i - 1], newChar: t[j - 1] });
                        i--; j--;
                    }
                }
            }
            
            return operations;
        }

        // åˆå¹¶å·®å¼‚æ“ä½œ - é‡ç‚¹ä¿®æ”¹éƒ¨åˆ†ï¼šå°†ç›¸é‚»çš„æ–°å¢ä¸æ›¿æ¢åˆå¹¶ä¸ºæ›¿æ¢
        function mergeOperations(operations) {
            if (!operations.length) return { mergedOps: [], explanations: [] };
            
            // é¢„å¤„ç†ï¼šå°†ç›¸é‚»çš„æ›¿æ¢å’Œæ’å…¥åˆå¹¶ä¸ºæ›¿æ¢
            const preprocessed = [];
            let i = 0;
            
            while (i < operations.length) {
                // å¤„ç†æ›¿æ¢åé¢è·Ÿç€æ’å…¥çš„æƒ…å†µ
                if (operations[i].type === 'replace' && i + 1 < operations.length && operations[i + 1].type === 'insert') {
                    preprocessed.push({
                        type: 'replace',
                        oldChar: operations[i].oldChar,
                        newChar: operations[i].newChar + operations[i + 1].char
                    });
                    i += 2; // è·³è¿‡å·²åˆå¹¶çš„ä¸¤ä¸ªæ“ä½œ
                } 
                // å¤„ç†æ’å…¥åé¢è·Ÿç€æ›¿æ¢çš„æƒ…å†µ
                else if (operations[i].type === 'insert' && i + 1 < operations.length && operations[i + 1].type === 'replace') {
                    preprocessed.push({
                        type: 'replace',
                        oldChar: operations[i + 1].oldChar,
                        newChar: operations[i].char + operations[i + 1].newChar
                    });
                    i += 2; // è·³è¿‡å·²åˆå¹¶çš„ä¸¤ä¸ªæ“ä½œ
                } 
                // å¤„ç†æ’å…¥åé¢è·Ÿç€æ’å…¥çš„æƒ…å†µï¼ˆåˆå¹¶ä¸ºä¸€ä¸ªæ’å…¥ï¼‰
                else if (operations[i].type === 'insert' && i + 1 < operations.length && operations[i + 1].type === 'insert') {
                    preprocessed.push({
                        type: 'insert',
                        char: operations[i].char + operations[i + 1].char
                    });
                    i += 2;
                } 
                // å¤„ç†æ›¿æ¢åé¢è·Ÿç€æ›¿æ¢çš„æƒ…å†µï¼ˆåˆå¹¶ä¸ºä¸€ä¸ªæ›¿æ¢ï¼‰
                else if (operations[i].type === 'replace' && i + 1 < operations.length && operations[i + 1].type === 'replace') {
                    preprocessed.push({
                        type: 'replace',
                        oldChar: operations[i].oldChar + operations[i + 1].oldChar,
                        newChar: operations[i].newChar + operations[i + 1].newChar
                    });
                    i += 2;
                } 
                // å…¶ä»–æƒ…å†µç›´æ¥æ·»åŠ 
                else {
                    preprocessed.push(operations[i]);
                    i++;
                }
            }
            
            // è¿›ä¸€æ­¥åˆå¹¶æ“ä½œæˆç»„
            const mergedOps = [];
            const explanations = [];
            let currentGroup = null;
            let step = 1;
            
            preprocessed.forEach(op => {
                if (currentGroup) {
                    // åˆå¹¶åŒç±»æ“ä½œ
                    if ((currentGroup.type === 'delete-group' && op.type === 'delete') ||
                        (currentGroup.type === 'insert-group' && op.type === 'insert') ||
                        (currentGroup.type === 'replace-group' && op.type === 'replace')) {
                        
                        if (op.type === 'delete') currentGroup.chars += op.char;
                        else if (op.type === 'insert') currentGroup.chars += op.char;
                        else if (op.type === 'replace') {
                            currentGroup.oldChars += op.oldChar;
                            currentGroup.newChars += op.newChar;
                        }
                        return;
                    }
                    
                    // å¤„ç†æ›¿æ¢ç»„åé¢è·Ÿç€æ’å…¥ç»„çš„æƒ…å†µ - åˆå¹¶ä¸ºæ›¿æ¢
                    if (currentGroup.type === 'replace-group' && op.type === 'insert') {
                        currentGroup.newChars += op.char;
                        return;
                    }
                    
                    // å¤„ç†æ’å…¥ç»„åé¢è·Ÿç€æ›¿æ¢ç»„çš„æƒ…å†µ - åˆå¹¶ä¸ºæ›¿æ¢
                    if (currentGroup.type === 'insert-group' && op.type === 'replace') {
                        currentGroup.type = 'replace-group';
                        currentGroup.oldChars = op.oldChar;
                        currentGroup.newChars = currentGroup.chars + op.newChar;
                        delete currentGroup.chars;
                        return;
                    }
                    
                    // å¤„ç†åˆ é™¤ç»„åé¢è·Ÿç€æ’å…¥ç»„çš„æƒ…å†µ - è½¬æ¢ä¸ºæ›¿æ¢
                    if (currentGroup.type === 'delete-group' && op.type === 'insert') {
                        currentGroup.type = 'replace-group';
                        currentGroup.oldChars = currentGroup.chars;
                        currentGroup.newChars = op.char;
                        delete currentGroup.chars;
                        return;
                    }
                    
                    // å¤„ç†åˆ é™¤ç»„åé¢è·Ÿç€æ›¿æ¢ç»„çš„æƒ…å†µ - åˆå¹¶ä¸ºæ›¿æ¢
                    if (currentGroup.type === 'delete-group' && op.type === 'replace') {
                        currentGroup.type = 'replace-group';
                        currentGroup.oldChars = currentGroup.chars + op.oldChar;
                        currentGroup.newChars = op.newChar;
                        delete currentGroup.chars;
                        return;
                    }
                    
                    // ä¿å­˜å½“å‰ç»„
                    addExplanation(currentGroup, step++);
                    mergedOps.push(currentGroup);
                    currentGroup = null;
                }
                
                // åˆ›å»ºæ–°ç»„
                if (op.type === 'delete') {
                    currentGroup = { type: 'delete-group', chars: op.char };
                } else if (op.type === 'insert') {
                    currentGroup = { type: 'insert-group', chars: op.char };
                } else if (op.type === 'replace') {
                    currentGroup = { type: 'replace-group', oldChars: op.oldChar, newChars: op.newChar };
                } else {
                    mergedOps.push(op);
                }
            });
            
            // å¤„ç†æœ€åä¸€ç»„
            if (currentGroup) {
                addExplanation(currentGroup, step++);
                mergedOps.push(currentGroup);
            }
            
            // æ·»åŠ è§£é‡Š
            function addExplanation(group, step) {
                let explanation = '';
                switch(group.type) {
                    case 'delete-group': explanation = `åˆ é™¤äº†"${group.chars}"`; break;
                    case 'insert-group': explanation = `æ–°å¢äº†"${group.chars}"`; break;
                    case 'replace-group': explanation = `å°†"${group.oldChars}"æ›¿æ¢ä¸º"${group.newChars}"`; break;
                }
                explanations.push({ step, type: group.type, text: explanation });
            }
            
            return { mergedOps, explanations };
        }

        // ç”Ÿæˆå·®å¼‚å¯è§†åŒ–HTML
        function generateMergedView(operations) {
            const { mergedOps } = mergeOperations(operations);
            let html = '';
            
            mergedOps.forEach(op => {
                switch (op.type) {
                    case 'match': html += op.char; break;
                    case 'delete-group': html += `<span class="diff-delete">${op.chars}</span>`; break;
                    case 'insert-group': html += `<span class="diff-insert">${op.chars}</span>`; break;
                    case 'replace-group': html += `<span class="diff-replace-old">${op.oldChars}</span><span class="diff-replace-new">${op.newChars}</span>`; break;
                }
            });
            
            return { html };
        }

        // ç”Ÿæˆä¿®æ­£è¯´æ˜HTML
        function generateExplanationsHtml(explanationText) {
            if (!explanationText?.trim()) {
                return '<p class="text-gray-500 italic">æ²¡æœ‰ä¿®æ­£è¯´æ˜ã€‚</p>';
            }
            
            const lines = explanationText.trim().split('\n');
            if (lines.length === 1) return `<p>${lines[0]}</p>`;
            
            let html = '<ol class="list-decimal space-y-4 pl-5">';
            lines.forEach(line => {
                if (!line.trim()) return;
                html += `<li class="flex items-start">${line}</li>`;
            });
            html += '</ol>';
            return html;
        }
        
        // ç”Ÿæˆå¼•ç”¨åŸæ–‡HTMLï¼ˆå¢åŠ äº†å‡ºå¤„sourceä¿¡æ¯ï¼‰
        function generateClosestReferenceHtml(reference) {
            if (!reference || (!reference.content && !reference.doctitle)) {
                return '<p class="text-gray-500 italic">æ²¡æœ‰æ‰¾åˆ°å¼•ç”¨åŸæ–‡</p>';
            }
            
            // æ”¶é›†å…ƒæ•°æ®ï¼ˆæ—¶é—´ã€åœ°ç‚¹å’Œå‡ºå¤„ï¼‰
            const metadata = [];
            if (reference.speechtime) metadata.push(`è®²è¯æ—¶é—´: ${reference.speechtime}`);
            if (reference.location) metadata.push(`åœ°ç‚¹: ${reference.location}`);
            if (reference.pubdate) metadata.push(`å‘å¸ƒæ—¶é—´: ${reference.pubdate}`);
            if (reference.source) metadata.push(`å‡ºå¤„: ${reference.source}`);
            
            return `
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    ${reference.doctitle ? `
                        <div class="px-3 py-2 bg-gray-50 border-b border-gray-100 text-sm font-medium">
                            <strong>${reference.doctitle}</strong>
                        </div>
                    ` : ''}
                    
                    ${metadata.length > 0 ? `
                        <div class="px-3 py-1 bg-gray-50 border-b border-gray-100 reference-metadata">
                            ${metadata.join(' | ')}
                        </div>
                    ` : ''}
                    
                    <div class="p-3 text-sm whitespace-pre-line">${reference.content || 'æ— å†…å®¹'}</div>
                </div>
            `;
        }
        
        // åˆ›å»ºå¼•ç”¨é“¾æ¥
        function createReferenceLink(reference) {
            if (!reference || (!reference.content && !reference.doctitle)) return '';
            
            elements.referenceModalContent.innerHTML = generateClosestReferenceHtml(reference);
            return `
                <button onclick="window.showReferenceModal()" 
                    class="text-primary hover:text-primary/80 text-sm font-medium flex items-center transition-colors">
                    <i class="fa fa-link mr-1"></i>å¼•ç”¨åŸæ–‡
                </button>
            `;
        }
        
        // è®¾ç½®æœç´¢å¤„ç†å‡½æ•°
        function setupSearchHandlers() {
            // æ¨¡å¼åˆ‡æ¢äº‹ä»¶
            elements.verifyModeCheckbox.addEventListener('change', function() {
                checkInputContent();
            });
            
            // æ¸…é™¤æŒ‰é’®
            elements.clearButton.addEventListener('click', () => {
                clearInputContent();
                document.getElementById('search-type-speech').checked = true;
                elements.selectedKnowledgeSource.textContent = 'çŸ¥è¯†æº: é‡è¦è®²è¯';
                elements.verifyModeCheckbox.checked = true;
                elements.useLlmEnhancement.checked = true;
                
                checkInputContent();
                
                [elements.loadingIndicator, elements.resultsContainer, elements.errorMessage].forEach(el => el.classList.add('hidden'));
                elements.initialState.classList.remove('hidden');
                
                searchResultsData = null;
                elements.showEntriesLink.classList.add('hidden');
            });
            
            // æ˜¾ç¤º/éšè—å…ƒç´ 
            const showSection = (section) => {
                section.classList.remove('hidden');
                section.classList.add('animate-fadeIn');
                setTimeout(() => section.classList.remove('animate-fadeIn'), 300);
            };
            
            const hideSection = (section) => section.classList.add('hidden');
            
            // è·å–é€‰ä¸­çš„æœç´¢ç±»å‹
            const getSelectedSearchType = () => {
                for (const radio of elements.searchTypeRadios) {
                    if (radio.checked) return radio.value;
                }
                return 'speech';
            };
            
            // æ‰§è¡Œæœç´¢
            const performSearch = async () => {
                const searchText = getCurrentModeTextContent();
                if (!searchText) return;
                
                currentSearchType = getSelectedSearchType();
                const useLlm = elements.useLlmEnhancement.checked;
                const functionType = elements.verifyModeCheckbox.checked ? 'verify' : 'qa';
                
                // å›ºå®šæ—¶é—´å‚æ•°ä¸º0
                const startTimeValue = 0;
                const endTimeValue = 0;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                [elements.initialState, elements.resultsContainer, elements.errorMessage].forEach(hideSection);
                showSection(elements.loadingIndicator);
                
                try {
                    const requestStartTime = performance.now();
                    const requestData = {
                        text_to_search: searchText,
                        use_llm_enhancement: useLlm,
                        function_type: functionType
                    };
                    
                    // æ— è®ºæœç´¢ç±»å‹ï¼Œéƒ½æ·»åŠ æ—¶é—´å‚æ•°ä¸º0
                    requestData.start_time = startTimeValue;
                    requestData.end_time = endTimeValue;
                    
                    const response = await fetch(apiUrls[currentSearchType], {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData),
                        timeout: useLlm ? 60000 : 30000
                    });
                    
                    const result = await response.json();
                    const requestEndTime = performance.now();
                    
                    if (!response.ok) {
                        throw new Error(result.error || `æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                    }
                    
                    // ä¿å­˜ç»“æœæ•°æ®
                    searchResultsData = {
                        ...result,
                        function_type: functionType,
                        processing_time_seconds: result.processing_time_seconds || (requestEndTime - requestStartTime) / 1000,
                        use_llm_enhancement: useLlm,
                        api_type: currentSearchType,
                        original_text: searchText,
                        time_range: {
                            start_time: startTimeValue,
                            end_time: endTimeValue
                        }
                    };
                    
                    displayResults(searchResultsData);
                    
                } catch (error) {
                    hideSection(elements.loadingIndicator);
                    elements.errorDetails.textContent = error.message;
                    showSection(elements.errorMessage);
                    elements.showEntriesLink.classList.add('hidden');
                }
            };
            
            // æ˜¾ç¤ºç»“æœ
            const displayResults = (data) => {
                hideSection(elements.loadingIndicator);
                
                elements.resultStats.textContent = `æ‰¾åˆ° ${data.result_count} æ¡ç»“æœ`;
                elements.processingTime.textContent = `è€—æ—¶: ${data.processing_time_seconds.toFixed(2)} ç§’`;
                
                const isVerifyMode = data.function_type === 'verify';
                const referenceLink = createReferenceLink(data.closest_reference);
                
                // æ˜¾ç¤º/éšè—ä¸­é—´ç»“æœé“¾æ¥
                elements.showEntriesLink.classList.toggle('hidden', !(data.result_count > 0 && data.items?.length));
                
                if (isVerifyMode && data.processed_content?.trim() && data.original_text?.trim()) {
                    // æ˜¾ç¤ºå·®å¼‚å¯è§†åŒ–
                    elements.diffVisualizationContainer.classList.remove('hidden');
                    elements.processedContentContainer.classList.add('hidden');
                    
                    const operations = getEditOperations(data.original_text, data.processed_content);
                    const { html } = generateMergedView(operations);
                    
                    elements.diffMergedView.innerHTML = html;
                    elements.diffReferenceLinkContainer.innerHTML = referenceLink;
                    
                    const explanationText = data.verify_components?.explanation || '';
                    elements.diffExplanations.innerHTML = generateExplanationsHtml(explanationText);
                } else {
                    // æ˜¾ç¤ºå¤„ç†ç»“æœ
                    elements.diffVisualizationContainer.classList.add('hidden');
                    elements.processedContentContainer.classList.remove('hidden');
                    
                    if (data.processed_content?.trim()) {
                        elements.processedContent.innerHTML = `<div>${data.processed_content.trim().replace(/\n/g, '<br>')}</div>`;
                    } else if (data.items?.length) {
                        elements.processedContent.innerHTML = `<div>${data.items[0].content.trim().replace(/\n/g, '<br>')}</div>`;
                    } else {
                        elements.processedContent.innerHTML = '<p class="text-gray-500">æ— æ£€ç´¢ç»“æœ</p>';
                    }
                    
                    elements.processedReferenceLinkContainer.innerHTML = referenceLink;
                }
                
                // æ˜¾ç¤º/éšè—æ— ç»“æœçŠ¶æ€
                elements.noResults.classList.toggle('hidden', !(data.result_count === 0 || !data.items?.length));
                showSection(elements.resultsContainer);
            };
            
            // ç»‘å®šæœç´¢äº‹ä»¶
            elements.searchButton.addEventListener('click', performSearch);
            elements.retryButton.addEventListener('click', performSearch);
            elements.tryAgainButton.addEventListener('click', () => {
                elements.useLlmEnhancement.checked = true;
                performSearch();
            });
            
            // æŒ‰Enteré”®æœç´¢
            document.addEventListener('keydown', e => {
                if (e.key === 'Enter' && e.ctrlKey && !elements.searchButton.disabled) {
                    e.preventDefault();
                    performSearch();
                }
            });
        }
        
        // æ˜¾ç¤ºä¸­é—´ç»“æœï¼ˆå¢åŠ äº†å‡ºå¤„sourceä¿¡æ¯ï¼‰
        function displayIntermediateResults(data) {
            // é‡ç½®ä¸­é—´ç»“æœé¡µé¢
            elements.entriesSubpages.forEach(page => {
                page.innerHTML = '';
                page.classList.add('hidden');
            });
            elements.entriesDefaultContent.classList.remove('hidden');
            elements.entriesSubnavBtns.forEach(btn => btn.classList.remove('opacity-50', 'pointer-events-none', 'cursor-not-allowed'));
            
            // å¢å¼ºææ–™ç”Ÿæˆé¡µé¢
            if (data.intermediate_results?.generation_info && data.use_llm_enhancement) {
                const genData = data.intermediate_results.generation_info;
                let genDetails = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm text-gray-500 mb-1">ç”Ÿæˆæ€»æ•°</div>
                            <div class="font-medium">${genData.total_generated}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm text-gray-500 mb-1">æœ‰æ•ˆç”Ÿæˆ</div>
                            <div class="font-medium">${genData.valid_generated}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm text-gray-500 mb-1">ç”Ÿæˆé”™è¯¯</div>
                            <div class="font-medium ${genData.generation_errors > 0 ? 'text-red-600' : ''}">${genData.generation_errors}</div>
                        </div>
                    </div>
                `;
                
                if (genData.processed_original_text) {
                    genDetails += `
                        <div class="mb-4">
                            <div class="text-sm font-medium mb-2">åŸå§‹æ–‡æœ¬</div>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm">${genData.processed_original_text}</div>
                        </div>
                    `;
                }
                
                if (genData.generated_materials?.length) {
                    genDetails += `
                        <div>
                            <div class="text-sm font-medium mb-2">ç”Ÿæˆçš„è¡¥å……ææ–™</div>
                            <div class="space-y-3">
                                ${genData.generated_materials.map((material, idx) => `
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm">
                                        <div class="text-xs text-gray-500 mb-1">è¡¥å……ææ–™ #${idx+1}</div>
                                        ${material}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('generation-info-page').innerHTML = genDetails;
            } else {
                document.querySelector('[data-entries-page="generation-info"]').classList.add('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
            }
            
            // ç›¸å…³è¯æ¡é¡µé¢ï¼ˆå¢åŠ äº†å‡ºå¤„sourceä¿¡æ¯ï¼‰
            if (data.items?.length) {
                let entriesHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm text-gray-500 mb-1">æ€»è¯æ¡æ•°</div>
                            <div class="font-medium">${data.items.length}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm text-gray-500 mb-1">æœ€é«˜åˆ†æ•°</div>
                            <div class="font-medium">${Math.max(...data.items.map(i => i.score)) || 0}</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4 max-h-[calc(100vh-400px)] overflow-y-auto pr-2">
                        ${data.items.map((item, idx) => `
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <div class="px-3 py-2 bg-gray-50 border-b border-gray-100 flex flex-wrap justify-between items-center gap-2">
                                    <div class="text-sm font-medium">è¯æ¡ #${idx+1}</div>
                                    <div class="text-xs text-gray-500 flex flex-wrap gap-x-4 gap-y-1">
                                        åˆ†æ•°: ${item.score || 0}
                                        ${item.location ? ` | ä½ç½®: ${item.location}` : ''}
                                        ${data.api_type === 'speech' && item.speechtime ? ` | è®²è¯æ—¶é—´: ${item.speechtime}` : ''}
                                        ${data.api_type === 'speech' && item.pubdate ? ` | å‘å¸ƒæ—¶é—´: ${item.pubdate}` : ''}
                                        ${item.source ? ` | å‡ºå¤„: ${item.source}` : ''}
                                    </div>
                                </div>
                                ${item.doctitle ? `
                                    <div class="px-3 py-2 bg-gray-50 border-b border-gray-100 text-sm font-medium">
                                        <strong>${item.doctitle}</strong>
                                    </div>
                                ` : ''}
                                <div class="p-3 text-sm whitespace-pre-line">${item.content || 'æ— å†…å®¹'}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.getElementById('search-entries-page').innerHTML = entriesHtml;
            } else {
                document.querySelector('[data-entries-page="search-entries"]').classList.add('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
            }
        }
        
        // åˆå§‹åŒ–
        function init() {
            initCollapsibleSections();
            initKnowledgeSourceDropdown(); // åˆå§‹åŒ–çŸ¥è¯†æºä¸‹æ‹‰èœå•
            initModals();
            initEntriesSubnav();
            initLocalRichTextEditor(); // åˆå§‹åŒ–æœ¬åœ°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            setupSearchHandlers();
        }
        
        // ç¡®ä¿DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body></html>